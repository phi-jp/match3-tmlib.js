var FRAME_RATE=30,SCREEN_WIDTH=480,SCREEN_HEIGHT=720,SCREEN_CENTER_X=SCREEN_WIDTH/2,SCREEN_CENTER_Y=SCREEN_HEIGHT/2,PIECE_SIZE=50,PIECE_IMAGE=null;tm.preload(function(){tm.sound.SoundManager.add("bgm","http://storage.tmlife.net/resource/bgm/maoudamashii/bgm_maoudamashii_healing02.wav",1),tm.sound.SoundManager.add("pinpon","sound/pinpon"),tm.sound.SoundManager.add("boo","sound/boo"),tm.util.DataManager.set("game-data",{time:0,score:0}),PIECE_IMAGE=tm.graphics.Canvas(),PIECE_IMAGE.width=PIECE_SIZE*9,PIECE_IMAGE.height=PIECE_SIZE;var e=["white","red","green","blue","yellow","purple","cyan"],t=PIECE_SIZE/2,n=PIECE_SIZE/2,r=PIECE_SIZE/2*.9;for(var i=0,s=e.length;i<s;++i){var o=t+i*PIECE_SIZE,u=n;color=e[i],PIECE_IMAGE.fillStyle=color,PIECE_IMAGE.fillCircle(o,u,r)}});var app=null;tm.main(function(){app=tm.app.CanvasApp("#world"),app.fps=FRAME_RATE,app.resize(SCREEN_WIDTH,SCREEN_HEIGHT),app.fitWindow(),app.enableStats();var e=tm.sound.SoundManager.get("bgm");e.loop=!0,e.volume=.5,e.play();var t=TitleScene();app.replaceScene(t),app.run()}),function(e){var t={children:[{type:"Label",name:"titleLabel",x:SCREEN_CENTER_X,y:150,width:SCREEN_WIDTH,text:"Match3 - tmlib.js",align:"center",fontSize:40},{type:"LabelButton",name:"playLabel",x:SCREEN_CENTER_X,y:360,width:150,width:SCREEN_WIDTH,text:"Play Game",align:"center",fontSize:25},{type:"LabelButton",name:"tweetLabel",x:SCREEN_CENTER_X,y:420,width:150,width:SCREEN_WIDTH,text:"Tweet",align:"center",fontSize:25},{type:"LabelButton",name:"rankingLabel",x:SCREEN_CENTER_X,y:480,width:150,width:SCREEN_WIDTH,text:"Ranking",align:"center",fontSize:25}]};e.TitleScene=tm.createClass({superClass:tm.app.Scene,init:function(e){this.superInit(),this.fromJSON(t),this.playLabel.ontouchstart=function(){var e=tm.app.Shape(SCREEN_WIDTH,SCREEN_HEIGHT).addChildTo(this);e.originX=e.originY=0,e.canvas.clearColor("white"),e.alpha=0,e.animation.fadeIn(1e3),e.blendMode="lighter",e.onanimationend=function(){app.replaceScene(MainScene())}}.bind(this),this.tweetLabel.onpointingstart=function(){window.open(tm.social.Twitter.createURL({type:"tweet",text:"『match3』 tmlib.js を使ってマッチ3ゲーム(Zookeeper)作りました.",hashtags:"match3,tmlibjs",url:"https://github.com/phi1618/match3-tmlib.js",via:"phi_jp"}),"_self")},this.rankingLabel.onpointingstart=function(){window.open("https://twitter.com/#!/search/%23match3%20%23tmlibjs","_self")}},update:function(e){},onblur:function(){app.pushScene(PauseScene())}})}(window),function(e){var t=600,n=SCREEN_WIDTH-80,r={children:[{type:"Label",name:"titleLabel",x:SCREEN_CENTER_X,y:80,width:SCREEN_WIDTH,text:"title",align:"center",fontSize:50},{type:"Label",name:"scoreLabel",x:350,y:125,width:SCREEN_WIDTH,text:"Score: 0",align:"center",fontSize:25},{type:"Label",name:"timeLabel",x:260,y:160,width:SCREEN_WIDTH,text:"Time:",fontSize:25,visible:!1},{type:"Shape",name:"gauge",x:40,y:170,width:n,height:25}]};e.MainScene=tm.createClass({superClass:tm.app.Scene,init:function(e){this.superInit(),this.frame=0,e=e||"default",this.gameData=tm.util.DataManager.get("game-data"),this.gameData.time=t,this.gameData.score=0,this.gameData.mode=e,this.fromJSON(r),this.titleLabel.text=e,this.gauge.originX=0,this.gauge.canvas.width=this.gauge.width,this.gauge.canvas.height=this.gauge.height,this.gauge.canvas.clearColor("white");var n=tm.app.Shape(PIECE_SIZE*8,PIECE_SIZE*8);n.position.set(SCREEN_CENTER_X,SCREEN_CENTER_Y+50),n.canvas.clearColor("rgba(255, 255, 255, 0.1)"),n.canvas.strokeStyle="white";for(var i=0;i<8;++i)for(var s=0;s<8;++s){var o=s*PIECE_SIZE,u=i*PIECE_SIZE;n.canvas.strokeRect(o,u,PIECE_SIZE,PIECE_SIZE)}n.addChildTo(this),this.pieceList=[];for(var i=0;i<8;++i)this.pieceList[i]=[];for(var i=0;i<8;++i)for(var s=0;s<8;++s){var o=s*PIECE_SIZE-PIECE_SIZE*4+PIECE_SIZE/2,u=i*PIECE_SIZE-PIECE_SIZE*4+PIECE_SIZE/2,a=Piece(tm.util.Random.randint(0,5)).addChildTo(n);a.setPosition(o,u),this.setPiece(s,i,a),a.ontouchmove=function(e){this.onpiecetouchmove(e)}.bind(this)}this.checkGather()},update:function(e){for(var r=0;r<8;++r)for(var i=0;i<8;++i){var s=i,o=r;this.checkFall(s,o)}this.checkAnimation()===!0&&this.checkGather(),this.gameData.time-=1,this.gauge.width=this.gameData.time/t*n,this.gameData.time<=0&&e.replaceScene(EndScene())},checkFall:function(e,t){var n=this.getPiece(e,t),r=this.getPieceTop(n);if(r&&r.isFall==1)return;t<=0?n.destroy==1&&(n.appear(),n.y=-PIECE_SIZE*4+PIECE_SIZE/2-PIECE_SIZE,n.fall(),n.setColor(tm.util.Random.randint(0,5))):n.destroy==1&&r.destroy==0&&(this.setPiece(e,t,r),this.setPiece(e,t-1,n),n.y-=PIECE_SIZE,r.fall(),this.checkFall(e,t-1))},checkAnimation:function(){for(var e=0;e<8;++e)for(var t=0;t<8;++t){var n=t,r=e,i=this.getPiece(n,r);if(i.isNormal()==0)return!1}return!0},checkGather:function(){for(var e=0;e<8;++e)for(var n=0;n<8;++n){var r=n,i=e,s=this.getPiece(r,i);if(n<6){var o=[s];this.checkPieceGather(s,1,0,o),o.length>=3&&(o.forEach(function(e){e.disappear()}),tm.sound.SoundManager.get("pinpon").play(),this.gameData.time=Math.min(this.gameData.time+25,t),this.gameData.score+=100,this.scoreLabel.text="Score:"+this.gameData.score)}if(e<6){var u=this.getPieceBottom(s),a=this.getPieceBottom(u);s.color==u.color&&s.color==a.color&&(s.disappear(),u.disappear(),a.disappear(),tm.sound.SoundManager.get("pinpon").play(),this.gameData.time=Math.min(this.gameData.time+25,t),this.gameData.score+=100,this.scoreLabel.text="Score:"+this.gameData.score)}}},checkPieceGather:function(e,t,n,r){var i=this.getPiece(e.indexX+t,e.indexY+n);return i&&e.color==i.color&&(r.push(i),this.checkPieceGather(i,t,n,r)),r},setPiece:function(e,t,n){this.pieceList[t][e]=n,n.indexX=e,n.indexY=t},swapPiece:function(e,t){var n=e.indexX,r=e.indexY,i=t.indexX,s=t.indexY;this.setPiece(n,r,t),this.setPiece(i,s,e)},getPiece:function(e,t){return this.pieceList[t]?this.pieceList[t][e]:null},getPieceLeft:function(e){return this.getPiece(e.indexX-1,e.indexY)},getPieceRight:function(e){return this.getPiece(e.indexX+1,e.indexY)},getPieceTop:function(e){return this.getPiece(e.indexX,e.indexY-1)},getPieceBottom:function(e){return this.getPiece(e.indexX,e.indexY+1)},canPieceMove:function(e){var t=e;while(t){if(t.isNormal()==0)return!1;t=this.getPieceBottom(t)}return!0},onpiecetouchmove:function(e){var t=e.target;if(this.canPieceMove(t)==0)return;var n=e.app.pointing,r=n.deltaPosition,i=r.length();if(i>4){var s=null,o=0,u=0,a=r.toAngle()*Math.RAD_TO_DEG;a+=360,a%=360,45<a&&a<135?(s=this.getPieceBottom(t),u=PIECE_SIZE):135<a&&a<225?(s=this.getPieceLeft(t),o=-PIECE_SIZE):225<a&&a<315?(s=this.getPieceTop(t),u=-PIECE_SIZE):(s=this.getPieceRight(t),o=PIECE_SIZE),s&&this.canPieceMove(s)==1&&(t.move(o,u),s.move(-o,-u),this.swapPiece(t,s))}},onblur:function(){app.pushScene(PauseScene())}})}(window),function(e){e.Piece=tm.createClass({superClass:tm.app.Sprite,init:function(e){this.superInit(),this.width=PIECE_SIZE,this.height=PIECE_SIZE,this.image=PIECE_IMAGE,this.srcRect.width=PIECE_SIZE,this.srcRect.height=PIECE_SIZE,this.interaction.enabled=!0,this.interaction.boundingType="rect",this.setColor(e),this.strokeStyle="rgba(0, 0, 0, 0)",this.destroy=!1,this.isMove=!1,this.isFall=!1,this.isDisappear=!1},setColor:function(e){this.color=e,this.setFrameIndex(e)},ontouchover:function(){this.strokeStyle="red"},ontouchout:function(){this.strokeStyle="rgba(0, 0, 0, 0)"},move:function(e,t){this.animation.move(e,t,250),this.isMove=!0,this.onanimationend=this._onmoveend},fall:function(){this.animation.move(0,PIECE_SIZE,200),this.isFall=!0,this.onanimationend=this._onfallend},appear:function(){this.destroy=!1,this.alpha=1},disappear:function(){this.animation.fade(0,1e3),this.animation.scale(1.5,1e3),this.onanimationend=this._ondisappearend,this.isDisappear=!0},isNormal:function(){return this.isMove==0&&this.isFall==0&&this.isDisappear==0&&this.destroy==0},_onfallend:function(){this.isFall=!1},_onmoveend:function(){this.isMove=!1},_ondisappearend:function(){this.scaleX=this.scaleY=1,this.destroy=!0,this.isDisappear=!1}})}(window),function(e){var t={children:[{type:"Label",name:"scoreLabel",x:SCREEN_WIDTH/2,y:300,width:SCREEN_WIDTH,fillStyle:"white",text:"Score:",fontSize:30,align:"center"},{type:"LabelButton",name:"backButton",x:SCREEN_WIDTH-100,y:SCREEN_HEIGHT-50,width:160,height:50,fillStyle:"white",shadowColor:"#00f",shadowBlur:16,text:"Back Title",fontSize:25}]};e.EndScene=tm.createClass({superClass:tm.app.Scene,init:function(e){this.superInit(),this.gameData=tm.util.DataManager.get("game-data"),this.fromJSON(t),this.scoreLabel.text+=this.gameData.score,this.backButton.onpointingstart=function(){this.dispatchEvent(tm.event.Event("backbuttondown"))}.bind(this);var n="『{gameTitle}』\nScore:{score}".format({gameTitle:document.title,score:this.gameData.score}),r=tm.social.Twitter.createURL({type:"tweet",text:n,hashtags:"match3,tmlibjs",url:"https://github.com/phi1618/match3-tmlib.js"}),i=tm.app.iPhoneButton(150,50,"blue","Tweet").addChildTo(this);i.setPosition(SCREEN_WIDTH/2,470),i.onpointingstart=function(){window.open(r,"_self")}},onbackbuttondown:function(){app.replaceScene(TitleScene())},update:function(e){},onblur:function(){app.pushScene(PauseScene())}})}(window),function(e){e.PauseScene=tm.createClass({superClass:tm.app.Scene,init:function(e){this.superInit(),this.bgm=e;var t=tm.app.Shape(SCREEN_WIDTH,SCREEN_HEIGHT);t.setPosition(SCREEN_WIDTH/2,SCREEN_HEIGHT/2),t.canvas.clearColor("rgba(0, 0, 0, 1.0)"),this.addChild(t);var n=tm.app.Label("PAUSE").addChildTo(this);n.setPosition(SCREEN_CENTER_X,SCREEN_CENTER_Y).setWidth(SCREEN_WIDTH),n.setFontSize(40).setAlign("center").setBaseline("middle")},update:function(e){},onfocus:function(){app.start()},onblur:function(){app.stop(),tm.sound.SoundManager.get("bgm").pause()},onpointingstart:function(){app.popScene(),tm.sound.SoundManager.get("bgm").play()}})}(window)